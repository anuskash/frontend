<app-top-navbar></app-top-navbar>
<div class="browse-listings">
  <app-hero-banner
    [title]="'Browse Items'"
    [subtitle]="'Discover great deals from UoN students'"
  ></app-hero-banner>

  <div class="listings-layout">
    <app-sidebar-filters
      [categories]="categories"
      [conditions]="conditions"
      (filtersChange)="onFiltersChange($event)"
      title="Refine Results"
    ></app-sidebar-filters>

    <div class="listings-content">
      <div class="results-info">
        <span class="results-count">{{ filteredProducts.length }} items found</span>
        <button class="back-btn" (click)="goBack()">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </button>
      </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <p>Loading available products...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="error-state">
    <div class="error-icon">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <p>{{ errorMessage }}</p>
    <button class="retry-btn" (click)="loadAvailableProducts()">Try Again</button>
  </div>

  <!-- Products Grid -->
  <div *ngIf="!isLoading && !errorMessage" class="products-section">
    <!-- Empty State -->
    <div *ngIf="filteredProducts.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-search"></i>
      </div>
      <h3>No products found</h3>
      <p *ngIf="searchTerm || selectedCategory || selectedCondition || minPrice !== null || maxPrice !== null">
        Try adjusting your filters to see more results.
      </p>
      <p *ngIf="!searchTerm && !selectedCategory && !selectedCondition && minPrice === null && maxPrice === null">
        There are no products available at the moment.
      </p>
      <button *ngIf="searchTerm || selectedCategory || selectedCondition || minPrice !== null || maxPrice !== null" 
              class="clear-filters-btn" 
              (click)="clearFilters()">
        Clear Filters
      </button>
    </div>

    <!-- Products Grid -->
    <div *ngIf="filteredProducts.length > 0" class="products-grid">
      <div class="product-card" *ngFor="let product of filteredProducts">
        <!-- Product Image with Carousel -->
        <div class="card-image" (click)="openProductDetail(product)" style="cursor: pointer;">
          <img 
            [src]="(getCurrentImage(product) | imageUrl) || 'https://via.placeholder.com/300x200/f39c12/ffffff?text=No+Image'" 
            [alt]="product.productName">
          
          <!-- Image Navigation Arrows -->
          <div *ngIf="hasMultipleImages(product)" class="image-nav">
            <button class="nav-btn prev" (click)="previousImage(product, $event)" aria-label="Previous image">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="nav-btn next" (click)="nextImage(product, $event)" aria-label="Next image">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          
          <!-- Image Indicator -->
          <div *ngIf="hasMultipleImages(product)" class="image-indicator">
            {{ getImageIndicator(product) }}
          </div>
          
          <!-- Status Badge -->
          <div class="status-badge status-available">
            <i class="fas fa-check-circle"></i>
            Available
          </div>
          
          <!-- Save/Wishlist Button -->
          <button 
            class="save-btn" 
            [class.saved]="isProductSaved(product.productId)"
            [class.saving]="isSaving(product.productId)"
            (click)="toggleSave(product, $event)"
            [disabled]="isSaving(product.productId)"
            [title]="isProductSaved(product.productId) ? 'Remove from saved' : 'Save for later'">
            <i [class]="isSaving(product.productId) ? 'fas fa-spinner fa-spin' : (isProductSaved(product.productId) ? 'fas fa-heart' : 'far fa-heart')"></i>
          </button>
        </div>
        
        <!-- Card Content -->
        <div class="card-content" (click)="openProductDetail(product)" style="cursor: pointer;">
          <h3 class="product-title">{{ product.productName }}</h3>
          <p class="product-description" *ngIf="product.productDescription">
            {{ product.productDescription.length > 100 ? 
               (product.productDescription.substring(0, 100) + '...') : 
               product.productDescription }}
          </p>
          
          <div class="product-details">
            <div class="detail-item">
              <i class="fas fa-tag"></i>
              <span class="price">{{ formatPrice(product.price) }}</span>
            </div>
            <div class="detail-item" *ngIf="product.category">
              <i class="fas fa-folder"></i>
              <span>{{ product.category }}</span>
            </div>
            <div class="detail-item" *ngIf="product.condition">
              <i class="fas fa-info-circle"></i>
              <span>{{ product.condition | titlecase }}</span>
            </div>
            <div class="detail-item" *ngIf="product.postedDate">
              <i class="fas fa-calendar"></i>
              <span>Posted {{ formatDate(product.postedDate) }}</span>
            </div>
          </div>

          <div class="seller-info">
            <i class="fas fa-user"></i>
            <span>{{ product.sellerName }}</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card-actions">
          <button class="action-btn primary" (click)="contactSeller(product)">
            <i class="fas fa-envelope"></i>
            Contact Seller
          </button>
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>
</div>

<!-- Product Detail Modal -->
<app-product-detail-modal
  [product]="selectedProductForDetail"
  [show]="showProductDetailModal"
  (closeModal)="closeProductDetail()"
></app-product-detail-modal>

<!-- Contact Seller Modal -->
<div class="modal-overlay" *ngIf="showContactModal" (click)="closeContactModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Contact Seller</h3>
      <button class="close-btn" (click)="closeContactModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <p class="product-info">
        <strong>Product:</strong> {{ selectedProductName }}
      </p>
      
      <div class="seller-info-header">
        <h4>Contact {{ selectedSellerName }}</h4>
      </div>
      
      <!-- Loading State -->
      <div *ngIf="isLoadingSellerInfo" class="loading-seller-info">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading seller information...</span>
      </div>
      
      <!-- Seller Contact Information -->
      <div *ngIf="!isLoadingSellerInfo" class="seller-contact-info">
        <div class="contact-field">
          <label>Email:</label>
          <div class="contact-container">
            <input 
              type="email" 
              [value]="selectedSellerEmail" 
              readonly 
              class="contact-input">
            <button class="copy-btn" (click)="copyEmailToClipboard()" title="Copy email to clipboard" [disabled]="!selectedSellerEmail">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        
        <div class="contact-field" *ngIf="selectedSellerPhone">
          <label>Phone:</label>
          <div class="contact-container">
            <input 
              type="tel" 
              [value]="selectedSellerPhone" 
              readonly 
              class="contact-input">
            <button class="copy-btn" (click)="copyPhoneToClipboard()" title="Copy phone to clipboard">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        
        <div class="no-phone-message" *ngIf="!selectedSellerPhone && !isLoadingSellerInfo">
          <p><i class="fas fa-info-circle"></i> Phone number not available</p>
        </div>
      </div>
      
      <p class="instruction-text" *ngIf="!isLoadingSellerInfo">
        You can copy the contact information and reach out to the seller directly about this item.
      </p>
    </div>
    
    <div class="modal-footer">
      <button class="secondary-btn" (click)="closeContactModal()">Close</button>
      <a *ngIf="!isLoadingSellerInfo && selectedSellerEmail" 
         [href]="'mailto:' + selectedSellerEmail + '?subject=Interested in ' + selectedProductName" 
         class="primary-btn email-link">
        <i class="fas fa-envelope"></i>
        Send Email
      </a>
      <button *ngIf="isLoadingSellerInfo || !selectedSellerEmail" 
              class="primary-btn" 
              disabled>
        <i class="fas fa-spinner fa-spin" *ngIf="isLoadingSellerInfo"></i>
        <i class="fas fa-envelope" *ngIf="!isLoadingSellerInfo"></i>
        {{ isLoadingSellerInfo ? 'Loading...' : 'Email Not Available' }}
      </button>
    </div>
  </div>
</div>

<app-footer></app-footer>
